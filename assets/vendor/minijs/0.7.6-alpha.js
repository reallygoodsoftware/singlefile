(function(d,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(d=typeof globalThis<"u"?globalThis:d||self,p(d.minijs={}))})(this,function(d){"use strict";var W=d=>{throw TypeError(d)};var ee=(d,p,E)=>p.has(d)||W("Cannot "+E);var L=(d,p,E)=>p.has(d)?W("Cannot add the same private member more than once"):p instanceof WeakSet?p.add(d):p.set(d,E);var m=(d,p,E)=>(ee(d,p,"access private method"),E);var S,P,_,c,x,q,O,I,M,T,U,V,R,j;var p=function(l,n,i,e){var s;n[0]=0;for(var t=1;t<n.length;t++){var r=n[t++],o=n[t]?(n[0]|=r?1:2,i[n[t++]]):n[++t];r===3?e[0]=o:r===4?e[1]=Object.assign(e[1]||{},o):r===5?(e[1]=e[1]||{})[n[++t]]=o:r===6?e[1][n[++t]]+=o+"":r?(s=l.apply(o,p(l,o,i,["",null])),e.push(s),o[0]?n[0]|=2:(n[t-2]=0,n[t]=s)):e.push(o)}return e},E=new Map;function F(l){var n=E.get(this);return n||(n=new Map,E.set(this,n)),(n=p(this,n.get(l)||(n.set(l,n=function(i){for(var e,s,t=1,r="",o="",a=[0],u=function(f){t===1&&(f||(r=r.replace(/^\s*\n\s*|\s*\n\s*$/g,"")))?a.push(0,f,r):t===3&&(f||r)?(a.push(3,f,r),t=2):t===2&&r==="..."&&f?a.push(4,f,0):t===2&&r&&!f?a.push(5,0,!0,r):t>=5&&((r||!f&&t===5)&&(a.push(t,0,r,s),t=6),f&&(a.push(t,f,0,s),t=6)),r=""},b=0;b<i.length;b++){b&&(t===1&&u(),u(b));for(var v=0;v<i[b].length;v++)e=i[b][v],t===1?e==="<"?(u(),a=[a],t=3):r+=e:t===4?r==="--"&&e===">"?(t=1,r=""):r=e+r[0]:o?e===o?o="":r+=e:e==='"'||e==="'"?o=e:e===">"?(u(),t=1):t&&(e==="="?(t=5,s=r,r=""):e==="/"&&(t<5||i[b][v+1]===">")?(u(),t===3&&(a=a[0]),t=a,(a=a[0]).push(2,0,t),t=0):e===" "||e==="	"||e===`
`||e==="\r"?(u(),t=2):r+=e),t===3&&r==="!--"&&(t=4,a=a[0])}return u(),a}(l)),n),arguments,[])).length>1?n:n[0]}const g="ui-",H=[`${g}load`,`${g}change`,`${g}clickout`,`${g}clickme`,`${g}press`];function J(l){return l.replace(/^-+/,"").replace(/-+(.)/g,function(n,i){return i.toUpperCase()}).replace(/-+$/,"")}function z(l){if(typeof l!="string")return l;if(l==="")return"";if(l==="true")return!0;if(l==="false")return!1;if(l==="null")return null;if(l!=="undefined"){if(/^-?(\d+\.?\d*|\.\d+)([eE][-+]?\d+)?$/.test(l)){const n=Number(l);if(!isNaN(n)&&isFinite(n))return n}return l}}function G(l,n){if(!l||n==null)return[];const i=new Set,e=l.match(/[a-zA-Z_$][a-zA-Z0-9_$]*/g)||[];for(const s of e){if(s==="$")continue;const t=s.split(".")[0];t in n&&i.add(t)}return Array.from(i)}function A(l,n){const i=n.toLowerCase().trim();if(H.includes(i))return!0;if(!i.startsWith(g))return!1;const e=i.replace(g,"");return e?"on"+e in l:!1}function B(){return"Element_"+Date.now().toString(36)+"_"+Math.random().toString(36).substring(2,15)}const X=Object.getPrototypeOf(async function(){}).constructor,C="[mini.js]",k={$:l=>document.querySelector(l),$$:l=>document.querySelectorAll(l),wait:l=>new Promise(n=>setTimeout(n,l))},D=new Map,w={register(l,n){D.set(l,n)},get(l){return document.querySelector(`ui-state${l}`)},getAll(l){const n=document.querySelectorAll(`ui-state${l}`);return Array.from(n)},getComponent(l){return D.get(l)},html:(l,...n)=>F.bind((e,s,...t)=>{const r=document.createElement(e);return s&&Object.entries(s).forEach(([o,a])=>{o.startsWith("on")&&typeof a=="function"?r.addEventListener(o.slice(2).toLowerCase(),a):o==="className"?r.className=a:o==="style"&&typeof a=="object"?Object.assign(r.style,a):r.setAttribute(o,a)}),t.flat().forEach(o=>{typeof o=="string"||typeof o=="number"?r.appendChild(document.createTextNode(o)):o instanceof Node&&r.appendChild(o)}),r})(l,...n),render:(l,n)=>{if(!(n instanceof HTMLElement)){console.error(`${C} MiniJS.render: Container must be a valid HTMLElement`);return}if(n.replaceChildren)n.replaceChildren();else for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(l)}};class N{constructor(n,i,e,s){L(this,S);this.id=n,this.element=i,this.parent=e,this.variables=new Map,this.initialState={className:Array.from(this.element.classList)},this.abortControllers=new Map,s.forEach(t=>{this.bindAttribute(t)})}bindAttribute(n){if(!n.startsWith(g))return;if(m(this,S,P).call(this,n),!A(this.element,n)){this.evaluate(n);return}const i=n.replace(g,"");if(i==="load"){this.evaluate(n);return}const e=new AbortController;if(this.abortControllers.set(n,e),i==="change"){const s=this.element.type=="checkbox"||this.element.tagName=="select"?"change":"input";this.element.addEventListener(s,t=>{this.evaluate(n,t)},{signal:e.signal})}else i==="clickout"?document.addEventListener("click",s=>{document.documentElement.contains(s.target)&&(this.element.contains(s.target)||this.evaluate(n,s))},{signal:e.signal}):i==="clickme"?this.element.addEventListener("click",s=>{s.target===this.element&&this.evaluate(n,s)},{signal:e.signal}):i==="press"?(this.element.addEventListener("keyup",s=>{s.target===this.element&&["Enter","Space"].includes(s.code)&&(s.code=="Space"&&s.preventDefault(),this.evaluate(n,s))},{signal:e.signal}),this.element.addEventListener("click",s=>{this.evaluate(n,s)},{signal:e.signal}),this.element.addEventListener("touchstart",s=>{this.evaluate(n,s)},{signal:e.signal})):this.element.addEventListener(i,s=>{this.evaluate(n,s)},{signal:e.signal})}unbindAttribute(n){if(!n.startsWith(g))return;m(this,S,_).call(this,n);const i=this.abortControllers.get(n);i&&(i.abort(),this.abortControllers.delete(n))}async evaluate(n,i=null){const e=A(this.element,n),s=this.element.getAttributeNode(n);if(!s)return;const t=s.value;try{const r=[...new Set(Array.from(this.variables.values()).flatMap(u=>Array.from(u)))],o=await this.parent.interpret(t,this.element,{isExpression:!e,isReadOnly:!e,variables:r,event:i});if(e)return;const a=n.replace(g,"");if(a==="text")this.element.textContent=o==null?void 0:o.toString();else if(a==="checked")this.element.checked!==o&&o!=null&&(this.element.checked=o);else if(a==="value")this.element.value!==o&&o!=null&&(this.element.value=o);else if(a==="class")await this.evaluateClass(t,r,o);else if(a.startsWith("data-")){if(this.element.dataset[a.slice(4)]!==o&&o!=null){const u=a[4].toLowerCase()+a.slice(5);this.element.dataset[u]=o}}else this.element.setAttribute(a,o)}catch(r){return console.warn(`${C} Evaluation error:`,r),null}}async evaluateClass(n,i,e){const s=t=>t?t.split(" ").filter(Boolean):[];try{if(n.includes("?")&&n.includes(":")){const r=(n.match(/\?/g)||[]).length,o=(n.match(/:/g)||[]).length,a=r===1&&o===1,u=n.match(/^(.+?)\s*\?\s*(.+?)\s*:\s*(.+)$/);if(a&&u){const b=y=>{const h=y.trim();return h.startsWith("'")&&h.endsWith("'")||h.startsWith('"')&&h.endsWith('"')?h.slice(1,-1).replace(/\\'/g,"'").replace(/\\"/g,'"'):h.startsWith("`")&&h.endsWith("`")&&!h.includes("${")?h.slice(1,-1):h.includes("${")||h.includes("`")?null:h},v=b(u[2]),f=b(u[3]);if(v!==null&&f!==null){const y=new Set([...s(v),...s(f)]),h=this.initialState.className.filter(Q=>!y.has(Q)),Y=s(e==null?void 0:e.toString()),Z=[...h,...Y],K=[...new Set(Z)].join(" ");this.element.className=K;return}}}const t=new Set([...this.initialState.className,...s(e==null?void 0:e.toString())]);this.element.className=Array.from(t).join(" ")}catch(t){console.warn(`${C} Evaluation error:`,t);const r=new Set([...this.initialState.className,...s(e==null?void 0:e.toString())]);this.element.className=Array.from(r).join(" ")}}dispose(){var n,i,e,s;Array.from(this.abortControllers.keys()).forEach(t=>{this.unbindAttribute(t)}),this.parent.reactiveElements.delete(this.id),(n=this.parent.parentState)==null||n.reactiveElements.delete(this.id);for(const[t,r]of this.variables.entries())for(const o of r)(i=this.parent.dependencies.get(o))==null||i.delete(this.id),(s=(e=this.parent.parentState)==null?void 0:e.dependencies.get(o))==null||s.delete(this.id)}}S=new WeakSet,P=function(n){const i=this.element.getAttributeNode(n);if(!i)return;const e=G(i.value,this.parent.state);if(e.length===0)return;const s=this.variables.get(n)||new Set;e.forEach(t=>{s.add(t)}),this.variables.set(n,s),!A(this.element,n)&&e.forEach(t=>{const r=this.parent.isParentState(t),o=r?this.parent.parentState:this.parent,a=o.dependencies.get(t)||new Map,u=a.get(this.id)||new Set;u.add(i.name),a.set(this.id,u),o.dependencies.set(t,a),r&&!o.reactiveElements.has(this.id)&&o.reactiveElements.set(this.id,this)})},_=function(n){if(this.variables.delete(n),A(this.element,n)||(this.parent.dependencies.forEach((e,s)=>{const t=e.get(this.id);t&&t.delete(n)}),!this.parent.parentState))return;let i=!1;this.parent.parentState.dependencies.forEach((e,s)=>{const t=e.get(this.id);t&&(t.delete(n),t.size===0?e.delete(this.id):i=!0)}),i||this.parent.parentState.reactiveElements.delete(this.id)};class $ extends HTMLElement{constructor(){var e;super();L(this,c);const i=this;this.parentState=(e=this.parentElement)==null?void 0:e.closest("ui-state"),this.data={},this.state=new Proxy(this.data,{get(s,t){var r;return s[t]??((r=i.parentState)==null?void 0:r.state[t])},set(s,t,r){return!(t in s)&&i.parentState&&t in i.parentState.data?i.parentState.state[t]=r:(s[t]=r,i.onStateUpdate(t)),!0},has(s,t){var r;return t in s||t in(((r=i.parentState)==null?void 0:r.state)??{})}}),this.dependencies=new Map,this.reactiveElements=new Map,this.refs={},this.observer=null,this.componentName=null,this.componentMethods=null}isParentState(i){return i in this.data||this.parentState==null?!1:i in this.parentState.data}onStateUpdate(i){const e=this.dependencies.get(i);if(e)for(const[s,t]of e)for(const r of t){const o=this.reactiveElements.get(s);o&&o.evaluate(r)}}connectedCallback(){m(this,c,q).call(this);const i=this.querySelectorAll("*");m(this,c,T).call(this,i),m(this,c,O).call(this,i),m(this,c,U).call(this),m(this,c,x).call(this)}disconnectedCallback(){this.observer&&(this.reactiveElements.forEach(i=>{i.dispose()}),this.reactiveElements.clear(),this.refs={},this.observer.disconnect(),this.observer=null)}async interpret(i,e,s={isExpression:!0,isReadOnly:!1,variables:[],retries:0,forcedState:null,event:null}){try{if(this.componentMethods&&this.componentMethods[i])return this.componentMethods[i].call(this,s.event);const t=s.isExpression?i:`(async()=>{${i}})()`,r=s.forcedState||this.state,o={...r};this.componentMethods&&Object.keys(this.componentMethods).forEach(f=>{typeof this.componentMethods[f]=="function"&&(f in r||(o[f]=this.componentMethods[f].bind(this)))});const a=Object.entries(k).map(([f,y])=>`const ${f} = arguments[1].${f};`).join(`
`);let u;if(s.isReadOnly){const f=s.variables.map(h=>`let ${h} = arguments[0]['${h}'];`).join(`
`),y=[];this.componentMethods&&Object.keys(this.componentMethods).forEach(h=>{typeof this.componentMethods[h]=="function"&&!s.variables.includes(h)&&!(h in r)&&y.push(`const ${h} = arguments[0]['${h}'];`)}),u=`
        ${a}
        ${f}
        ${y.join(`
`)}
        const result = ${t};
        return result;
      `}else u=`
        ${a}
        with (arguments[0]) {
          const result = ${t};
          return result;
        }
      `;const b=new X(u).bind(e);return Object.defineProperty(b,"name",{value:`[mini.js] ${i}`}),await b(o,k)}catch(t){const r=s.retries??0;if((t instanceof SyntaxError||t.message.includes("expected expression"))&&r<1)return this.interpret(i,e,{...s,isExpression:!1,retries:r+1});throw t}}}c=new WeakSet,x=function(){this.componentName=this.getAttribute("component"),this.componentName&&(this.componentMethods=w.getComponent(this.componentName),this.componentMethods&&(Object.keys(this.componentMethods).forEach(i=>{typeof this.componentMethods[i]=="function"&&(this[i]=this.componentMethods[i].bind(this))}),"init"in this.componentMethods&&this.componentMethods.init.call(this,this)))},q=function(){const i=["id","class","component","style"];for(const e of this.attributes){if(i.includes(e.name))continue;const s=J(e.name);s&&(this.data[s]=z(e.value))}},O=function(i){for(const e of i){if(e.tagName==="UI-STATE"||e.closest("ui-state")!==this)continue;const t=e.getAttribute("ref");t&&(this.refs[t]=e)}},I=function(i,e=void 0){const s=e??i.getAttribute("ref");s&&(this.refs[s]=i)},M=function(i,e=void 0){const s=e??i.getAttribute("ref");s&&this.refs[s]===i&&delete this.refs[s]},T=function(i){for(const e of i){if(e.tagName==="UI-STATE"||e.closest("ui-state")!==this)continue;const t=B(),r=[];for(const a of e.attributes)a.name.startsWith(g)&&r.push(a.name);if(r.length===0)continue;const o=new N(t,e,this,r);this.reactiveElements.set(t,o)}},U=function(){this.observer=new MutationObserver(i=>{for(const e of i){if(e.removedNodes.length>0&&m(this,c,V).call(this,e.removedNodes),e.addedNodes.length>0&&m(this,c,R).call(this,e.addedNodes),!(e.type==="attributes"&&(e.attributeName.startsWith(g)||e.attributeName==="ref")))continue;if(e.attributeName==="ref"){const o=e.target;if(o.closest("ui-state")===this){const u=e.oldValue,b=o.getAttribute("ref");m(this,c,M).call(this,o,u),m(this,c,I).call(this,o,b)}continue}const s=m(this,c,j).call(this,e.target);if(!s)continue;const t=e.attributeName;s.element.getAttribute(t)===null?s.unbindAttribute(t):s.bindAttribute(t)}}),this.observer.observe(this,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0})},V=function(i){for(const e of i){if(e.nodeType!==Node.ELEMENT_NODE)continue;m(this,c,M).call(this,e);const s=e.querySelectorAll("[ref]");for(const r of s)m(this,c,M).call(this,r);const t=m(this,c,j).call(this,e);t&&t.dispose()}},R=function(i){for(const e of i){if(e.nodeType!==Node.ELEMENT_NODE)continue;const s=e.querySelectorAll("*"),t=[e,...s];m(this,c,T).call(this,t),m(this,c,O).call(this,t)}},j=function(i){for(const e of this.reactiveElements.values())if(e.element===i)return e;return null},typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{customElements.define("ui-state",$)}):customElements.define("ui-state",$)),typeof window<"u"&&(window.MiniJS=w),d.MiniJS=w,d.ReactiveElement=N,d.StateElement=$,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=mini.umd.js.map
